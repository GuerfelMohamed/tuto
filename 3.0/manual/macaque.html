<html><head><title>Type safe database requests using Macaque</title><meta charset="utf8"/><meta content="width=device-width, initial-scale=1" name="viewport"/><link rel="stylesheet" href="https://ocsigen.org/css/style.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/themes/prism.min.css"/><script type="text/javascript" src="https://ocsigen.org/js/client.js">
//<![CDATA[

//]]>
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-core.min.js">
//<![CDATA[

//]]>
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-ocaml.min.js">
//<![CDATA[

//]]>
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-clike.min.js">
//<![CDATA[

//]]>
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-reason.min.js">
//<![CDATA[

//]]>
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-javascript.min.js">
//<![CDATA[

//]]>
</script></head><body class="macaque tuto"><div class="project-page"><div class="page-header"><p class="logo-ocsigen"><a href=".././../../" class="ocsimore_phrasing_link"><img src=".././../../img/ocsigen-white.svg" alt="Ocsigen"/></a>
</p><div class="mainmenu"><p class="mainmenu-home"><a href=".././../../" class="ocsimore_phrasing_link">Home</a></p><p class="mainmenu-current mainmenu-doc"><a href=".././../../tuto/" class="ocsimore_phrasing_link">Doc</a></p><p><a href=".././../../eliom/" class="ocsimore_phrasing_link">Eliom</a></p><p><a href=".././../../js_of_ocaml/" class="ocsimore_phrasing_link">Js_of_ocaml</a></p><p><a href=".././../../lwt/" class="ocsimore_phrasing_link">Lwt</a></p><p><a href=".././../../tyxml/" class="ocsimore_phrasing_link">Tyxml</a></p><p><a href=".././../../ocsigen-start/" class="ocsimore_phrasing_link">Start</a></p></div><form id="googlesearch" action="https://google.com/search"><input name="q" id="gsearch-box" placeholder="Search using Google"/><label for="gsearch-box"><img src="/img/search.svg" alt="" id="gsearch-icon"/></label><input type="submit" id="gsearch-submit" onclick="document.getElementById('gsearch-box').value += ' site:ocsigen.org';"/></form><aside class="how-drawer"><input id="how-drawer-toggle" type="checkbox"/><label for="how-drawer-toggle" id="how-drawer-label"><span class="how-drawer-icon"></span></label><nav class="how-drawer-content"><ul class="drawermainmenu"><li class="drawermainmenu-home"><a href=".././../../" class="ocsimore_phrasing_link">Home</a>
</li><li class="drawermainmenu-doc"><a href=".././../../tuto/" class="ocsimore_phrasing_link">Doc</a>
</li><li class="drawermainmenu-project"><a href=".././../../eliom/" class="ocsimore_phrasing_link">Eliom</a>
</li><li class="drawermainmenu-project"><a href=".././../../js_of_ocaml/" class="ocsimore_phrasing_link">Js_of_ocaml</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsigenserver/" class="ocsimore_phrasing_link">Server</a>
</li><li class="drawermainmenu-project"><a href=".././../../lwt/" class="ocsimore_phrasing_link">Lwt</a>
</li><li class="drawermainmenu-project"><a href=".././../../tyxml/" class="ocsimore_phrasing_link">Tyxml</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsigen-toolkit/" class="ocsimore_phrasing_link">Toolkit</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsigen-start/" class="ocsimore_phrasing_link">Start</a>
</li><li class="drawermainmenu-project"><a href=".././../../html_of_wiki/" class="ocsimore_phrasing_link">html_of_wiki</a>
</li><li class="drawermainmenu-project"><a href=".././../../deriving/" class="ocsimore_phrasing_link">deriving</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsimore/" class="ocsimore_phrasing_link">Ocsimore (<em>deprecated</em>)</a>
</li><li class="drawermainmenu-page"><a href=".././../../projects" class="ocsimore_phrasing_link">Other projects</a>
</li><li class="drawermainmenu-page"><a href=".././../../papers" class="ocsimore_phrasing_link">Research papers</a>
</li><li class="drawermainmenu-page"><a href=".././../../credits" class="ocsimore_phrasing_link">Who does Ocsigen?</a>
</li><li class="drawermainmenu-page"><a href=".././../../contributing" class="ocsimore_phrasing_link">Contributing</a>
</li><li class="drawermainmenu-page"><a href=".././../../blog" class="ocsimore_phrasing_link">Blog</a>
</li><li class="drawermainmenu-page"><a href=".././../../install" class="ocsimore_phrasing_link">Installation</a>
</li><li class="drawermainmenu-page"><a href="https://github.com/ocsigen" class="ocsimore_phrasing_link">Source code</a>
</li></ul><nav class="how-doctree"><h1> Tutorial: Your first application</h1><h2><a href="intro" class="ocsimore_phrasing_link">Introduction</a></h2><h2><a href="application" class="ocsimore_phrasing_link">Client/server application</a></h2><h2><a href="interaction" class="ocsimore_phrasing_link">Service based Web programming</a></h2><h2><a href="misc" class="ocsimore_phrasing_link">Miscellaneous features</a></h2><h1> Examples: Learning by example</h1><h2><a href="chat" class="ocsimore_phrasing_link">Chat</a></h2><h1> Mini-tutorials: Some little examples</h1><h2><a href="tutowidgets" class="ocsimore_phrasing_link">Eliom apps basics: writing client server widgets</a></h2><h2><a href="macaque" class="ocsimore_phrasing_link">MaCaQue: SQL queries</a></h2><h2><a href="custom-conf" class="ocsimore_phrasing_link">Custom configuration</a></h2><h2><a href="ocsipersist" class="ocsimore_phrasing_link">Light database</a></h2><h2><a href="pictures" class="ocsimore_phrasing_link">Upload pictures</a></h2><h2><a href="music" class="ocsimore_phrasing_link">Playing music</a></h2><h2><a href="hash-password" class="ocsimore_phrasing_link">Protecting passwords</a></h2></nav></nav></aside></div><p class="reasonwarning">Warning: Reason support is experimental.
We are looking for beta-tester and contributors.
</p><button id="reason">Switch to </button><div class="twocols"><nav class="leftcol">Version <select class="how-versions" onchange="location = this.value;"><option value=".././../2.2/manual/macaque">2.2</option><option value=".././../3.0/manual/macaque" selected="selected">3.0</option><option value=".././../4.2/manual/macaque">4.2</option><option value=".././../5.0/manual/macaque">5.0</option><option value=".././../6.3/manual/macaque">6.3</option><option value=".././../6.4/manual/macaque">6.4</option><option value=".././../dev/manual/macaque">dev</option></select><nav class="how-doctree"><h1> Tutorial: Your first application</h1><h2><a href="intro" class="ocsimore_phrasing_link">Introduction</a></h2><h2><a href="application" class="ocsimore_phrasing_link">Client/server application</a></h2><h2><a href="interaction" class="ocsimore_phrasing_link">Service based Web programming</a></h2><h2><a href="misc" class="ocsimore_phrasing_link">Miscellaneous features</a></h2><h1> Examples: Learning by example</h1><h2><a href="chat" class="ocsimore_phrasing_link">Chat</a></h2><h1> Mini-tutorials: Some little examples</h1><h2><a href="tutowidgets" class="ocsimore_phrasing_link">Eliom apps basics: writing client server widgets</a></h2><h2><a href="macaque" class="ocsimore_phrasing_link">MaCaQue: SQL queries</a></h2><h2><a href="custom-conf" class="ocsimore_phrasing_link">Custom configuration</a></h2><h2><a href="ocsipersist" class="ocsimore_phrasing_link">Light database</a></h2><h2><a href="pictures" class="ocsimore_phrasing_link">Upload pictures</a></h2><h2><a href="music" class="ocsimore_phrasing_link">Playing music</a></h2><h2><a href="hash-password" class="ocsimore_phrasing_link">Protecting passwords</a></h2></nav></nav><article class="rightcol"><h1>Type safe database requests using Macaque</h1><aside class="concepts"><header><h5>Concepts</h5></header><p>Type safe database requests</p></aside><p>We will implement our database access function using
the Macaque library, that allows easy manipulation of Postgresql
database fully compatible with Lwt. (For more information see
<a href="https://github.com/ocsigen/macaque" class="ocsimore_phrasing_link"> Macaque manual</a>).
</p><p>We will store the login and the password of users in a Postgresql
database. For more information on how to set up and run it, see
<a href="http://www.postgresql.org/docs/9.0/static/index.html" class="ocsimore_phrasing_link">Postgresql
manual</a>.
</p><p>When the base is up and running, we create the base by running in a shell:
</p><pre class="manually-translated"><code class="language-sh">$ createdb testbase</code></pre><p>Then we create the <span class="teletype">users</span> table, by executing this sql script:
</p><pre class="manually-translated"><code class="language-sql">CREATE TABLE users (
       login text NOT NULL,
       password text NOT NULL
);</code></pre><p>We save it under <span class="teletype">create_table.sql</span> and run
</p><pre class="manually-translated"><code class="language-sh">$ psql -d testbase -f create_table.sql</code></pre><p>Macaque can use any thread library that provides a monadic
interface. The default one provides simple blocking access to the
database. It isn't good for us because an access to the base by one
user will prevent the server from handling anything else until the
request is finished. We need a version of Macaque specialised for
Lwt. It is obtained by
</p><pre class=""><code class="language-ocaml translatable">module Lwt_thread = struct
  include Lwt
  include Lwt_chan
end
module Lwt_PGOCaml = PGOCaml_generic.Make(Lwt_thread)
module Lwt_Query = Query.Make_with_Db(Lwt_thread)(Lwt_PGOCaml)</code></pre><p>We can now open the database with our newly created <span class="teletype">Lwt_PGOCaml.connect</span>.
</p><pre class=""><code class="language-ocaml translatable">let get_db : unit -&gt; unit Lwt_PGOCaml.t Lwt.t =
  let db_handler = ref None in
  fun () -&gt;
    match !db_handler with
      | Some h -&gt; Lwt.return h
      | None -&gt; Lwt_PGOCaml.connect ~database:&quot;testbase&quot; ()</code></pre><p>Then we declare the table on which we will work and the different
requests we do on it.
</p><pre class=""><code class="language-ocaml translatable">let table = &lt;:table&lt; users (
  login text NOT NULL,
  password text NOT NULL
) &gt;&gt;

let find name =
  (get_db () &gt;&gt;= fun dbh -&gt;
   Lwt_Query.view dbh
   &lt;:view&lt; {password = user_.password} |
            user_ in $table$;
            user_.login = $string:name$; &gt;&gt;)

let insert name pwd =
  get_db () &gt;&gt;= fun dbh -&gt;
  Lwt_Query.query dbh
  &lt;:insert&lt; $table$ :=
    { login = $string:name$; password = $string:pwd$; } &gt;&gt;</code></pre><p>Finally, we modify the handling code :
</p><pre class=""><code class="language-ocaml translatable">let check_pwd name pwd =
  (get_db () &gt;&gt;= fun dbh -&gt;
   Lwt_Query.view dbh
   &lt;:view&lt; {password = user_.password} |
            user_ in $table$;
            user_.login = $string:name$;
	    user_.password = $string:pwd$ &gt;&gt;)
  &gt;|= (function [] -&gt; false | _ -&gt; true)

let () = Eliom_registration.Action.register
  ~service:create_account_service
  (fun () (name, pwd) -&gt;
    find name &gt;&gt;=
      (function
	| [] -&gt; insert name pwd
	| _ -&gt; Lwt.return ()) )

let () = Eliom_registration.Action.register
  ~service:connection_service
  (fun () (name, password) -&gt;
    check_pwd name password &gt;&gt;=
      (function
	| true -&gt; Eliom_reference.set username (Some name)
	| false -&gt; Lwt.return ()))</code></pre><p>We need to reference <span class="teletype">macaque</span> in the <span class="teletype">Makefile</span> :
</p><pre>SERVER_PACKAGE := macaque.syntax
</pre><p>and in <span class="teletype">ocsigenserver.conf</span> :
</p><pre>&lt;extension findlib-package=&quot;macaque&quot;/&gt;
</pre></article></div></div></body></html>
