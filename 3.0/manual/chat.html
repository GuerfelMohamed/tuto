<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title> Chat: Design Overview </title><meta charset="utf8"/><meta content="width=device-width, initial-scale=1" name="viewport"/><link rel="stylesheet" href="/css/style.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/themes/prism.min.css"/><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-core.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-ocaml.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-clike.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-reason.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-javascript.min.js"></script><script src="/js/client.js"></script></head><body class="tuto 3.0"><div class="project-page"><div class="page-header"><p class="logo-ocsigen"><a href="/" class="ocsimore_phrasing_link"><img src="/img/ocsigen-white.svg" alt="Ocsigen"/></a>
</p><p class="logo-subproject">Doc
</p><ul class="mainmenu"><li class="mainmenu-home"><a href="/" class="ocsimore_phrasing_link">Home</a>
</li><li class="mainmenu-doc mainmenu-current"><a href="/tuto/6.2/manual/intro" class="ocsimore_phrasing_link">Doc</a>
</li><li><a href="/eliom/6.3/manual/intro" class="ocsimore_phrasing_link">Eliom</a>
</li><li><a href="/js_of_ocaml/3.1.0/manual/overview" class="ocsimore_phrasing_link">Js_of_ocaml</a>
</li><li><a href="/lwt/3.2.1/manual/manual" class="ocsimore_phrasing_link">Lwt</a>
</li><li><a href="/tyxml/4.1.0/manual/intro" class="ocsimore_phrasing_link">Tyxml</a>
</li><li><a href="/ocsigen-start/1.1.0/manual/intro" class="ocsimore_phrasing_link">Start</a>
</li></ul><div class="how-drawer"><input id="how-drawer-toggle" type="checkbox"/><label for="how-drawer-toggle" id="how-drawer-label"><span class="how-drawer-icon"></span></label><nav class="how-drawer-content"><ul class="drawermainmenu"><li class="drawermainmenu-home"><a href="/" class="ocsimore_phrasing_link">Home</a>
</li><li class="drawermainmenu-doc drawermainmenu-current"><a href="/tuto/6.2/manual/intro" class="ocsimore_phrasing_link">Doc</a>
</li><li><a href="/eliom/6.3/manual/intro" class="ocsimore_phrasing_link">Eliom</a>
</li><li><a href="/js_of_ocaml/3.1.0/manual/overview" class="ocsimore_phrasing_link">Js_of_ocaml</a>
</li><li><a href="/ocsigenserver/2.9/manual/quickstart" class="ocsimore_phrasing_link">Server</a>
</li><li><a href="/lwt/3.2.1/manual/manual" class="ocsimore_phrasing_link">Lwt</a>
</li><li><a href="/tyxml/4.1.0/manual/intro" class="ocsimore_phrasing_link">Tyxml</a>
</li><li><a href="/ocsigen-toolkit/1.1.0/manual/intro" class="ocsimore_phrasing_link">Toolkit</a>
</li><li><a href="/ocsigen-start/1.1.0/manual/intro" class="ocsimore_phrasing_link">Start</a>
</li><li class="drawermainmenu-page"><a href="/projects" class="ocsimore_phrasing_link">Other projects</a>
</li><li class="drawermainmenu-page"><a href="/papers" class="ocsimore_phrasing_link">Research papers</a>
</li><li class="drawermainmenu-page"><a href="/credits" class="ocsimore_phrasing_link">Who does Ocsigen?</a>
</li></ul><div class="how-doctree"><h1> Tutorial: Your first application</h1><h2><a href="/tuto/3.0/manual/intro" class="ocsimore_phrasing_link">Introduction</a></h2><h2><a href="/tuto/3.0/manual/application" class="ocsimore_phrasing_link">Client/server application</a></h2><h2><a href="/tuto/3.0/manual/interaction" class="ocsimore_phrasing_link">Service based Web programming</a></h2><h2><a href="/tuto/3.0/manual/misc" class="ocsimore_phrasing_link">Miscellaneous features</a></h2><h1> Examples: Learning by example</h1><h2><a href="/tuto/3.0/manual/chat" class="ocsimore_phrasing_link">Chat</a></h2><h1> Mini-tutorials: Some little examples</h1><h2><a href="/tuto/3.0/manual/tutowidgets" class="ocsimore_phrasing_link">Eliom apps basics: writing client server widgets</a></h2><h2><a href="/tuto/3.0/manual/macaque" class="ocsimore_phrasing_link">MaCaQue: SQL queries</a></h2><h2><a href="/tuto/3.0/manual/custom-conf" class="ocsimore_phrasing_link">Custom configuration</a></h2><h2><a href="/tuto/3.0/manual/ocsipersist" class="ocsimore_phrasing_link">Light database</a></h2><h2><a href="/tuto/3.0/manual/pictures" class="ocsimore_phrasing_link">Upload pictures</a></h2><h2><a href="/tuto/3.0/manual/music" class="ocsimore_phrasing_link">Playing music</a></h2><h2><a href="/tuto/3.0/manual/hash-password" class="ocsimore_phrasing_link">Protecting passwords</a></h2></div></nav></div></div><button id="reason">Switch to </button><div class="twocols"><div class="leftcol"><div class="how-versions"><input id="how-versions-toggle" type="checkbox"/><label for="how-versions-toggle" class="how-versions-current">Version 3.0</label><div class="how-versions-all"><a href="/tuto/dev/manual/chat">dev</a><a href="/tuto/6.2/manual/chat">6.2</a><a href="/tuto/6.1/manual/chat">6.1</a><a href="/tuto/6.0/manual/chat">6.0</a><a href="/tuto/5.0/manual/chat">5.0</a><a href="/tuto/4.2/manual/chat">4.2</a><a href="/tuto/4.1/manual/chat">4.1</a><a href="/tuto/4.0/manual/chat">4.0</a><span class="how-versions-all-current">3.0</span><a href="/tuto/2.2/manual/chat">2.2</a><a href="/tuto/2.0/manual/chat">2.0</a></div></div><form id="search"><input name="q" id="q" placeholder="search ..."/><button>Search</button></form><div class="how-doctree"><h1> Tutorial: Your first application</h1><h2><a href="/tuto/3.0/manual/intro" class="ocsimore_phrasing_link">Introduction</a></h2><h2><a href="/tuto/3.0/manual/application" class="ocsimore_phrasing_link">Client/server application</a></h2><h2><a href="/tuto/3.0/manual/interaction" class="ocsimore_phrasing_link">Service based Web programming</a></h2><h2><a href="/tuto/3.0/manual/misc" class="ocsimore_phrasing_link">Miscellaneous features</a></h2><h1> Examples: Learning by example</h1><h2><a href="/tuto/3.0/manual/chat" class="ocsimore_phrasing_link">Chat</a></h2><h1> Mini-tutorials: Some little examples</h1><h2><a href="/tuto/3.0/manual/tutowidgets" class="ocsimore_phrasing_link">Eliom apps basics: writing client server widgets</a></h2><h2><a href="/tuto/3.0/manual/macaque" class="ocsimore_phrasing_link">MaCaQue: SQL queries</a></h2><h2><a href="/tuto/3.0/manual/custom-conf" class="ocsimore_phrasing_link">Custom configuration</a></h2><h2><a href="/tuto/3.0/manual/ocsipersist" class="ocsimore_phrasing_link">Light database</a></h2><h2><a href="/tuto/3.0/manual/pictures" class="ocsimore_phrasing_link">Upload pictures</a></h2><h2><a href="/tuto/3.0/manual/music" class="ocsimore_phrasing_link">Playing music</a></h2><h2><a href="/tuto/3.0/manual/hash-password" class="ocsimore_phrasing_link">Protecting passwords</a></h2></div></div><div class="rightcol"><h1> Chat: Design Overview </h1><p><em>Chat</em> is a chatting module and application, currently for conversations
between two users each. (Extension for multi-user channels is left as an
exercise to the user.)
</p><p>First of all,
</p><ul><li> <a href="/chat" class="ocsimore_phrasing_link">try it</a>! And
</li><li> <a href="/darcsweb/?r=tutorial;a=tree;f=/src-examples/chat" class="ocsimore_phrasing_link">browse it</a>,
</li><li> <span class="monospace">darcs get <a href="http://ocsigen.org/darcs/tutorial" class="ocsimore_phrasing_link">http://ocsigen.org/darcs/tutorial</a>; cd tutorial/src-examples/chat</span> it, or
</li><li> <a href="/download/chat.tar.gz" class="ocsimore_phrasing_link">download</a> the source code.
</li></ul><h2> Description </h2><p>When the user is logged in, he sees a list of available users. He can choose
one of them to start a conversation with him. The conversation then becomes
visible to both users as a message prompt and a growing list of messages.  The
participating users can enter messages and they are made visible to the other
participants.  If a user becomes unavailable for <em>Chat</em>, he is removed from the
list of available users, and all conversations he was participating are removed
from the opponent's UI.
</p><h2> Central Data Types </h2><p>The following data are crucial to the functionality of <em>Chat</em>.
</p><h3> Conversation </h3><p>A conversation (<span class="monospace">type Shared.Conversation.t</span>) is shared between all its
client participants. It comprises of two values: Firstly, it contains a bus for
transferring conversation messages (c.f. <span class="monospace">type Shared.Conversation.message</span>)
between the participants. Those are displayed as they come on every client.
Secondly, it contains the set of participating users. This is used when the
conversation is teared down: An event for removing the UI element for the
conversation is sent to every participant.
</p><h3> Client Process </h3><p>When a user enters a web page which contains <em>Chat</em>, it is rendered in HTML and
a new client process is created in doing so.  Every client process holds a
channel, where the server can send messages to <em>add or to remove conversations</em>
(c.f. <span class="monospace">type Shared.event</span>).
</p><h3> User Info </h3><p>On the server side, the channel for those events is stored for each user along
with a list of conversations he participates in.  This is done with a
Eliom-reference of scope <span class="monospace">session_group</span>, such that it is shared among all
sessions of a user (and likewise all client processes).
</p><p>But, when one user requests to start (or end) a conversation with any another
user, it is also necessary to access the event channel of any user.
As it is only stored in an Eliom-reference specific to the user, it is
impossible to access.  In favour of this, the user info is moreover
stored in a weak hash table (c.f. module <span class="monospace">Weak_info</span>) which associates the
user info to each user in a globally accessible way. This association is weak
in its value, the user info, such that it is garbage-collected as soon as the
Eliom-reference storing it is cleared, i.e. when the last session of the
respective user is closed.
</p><h3> Available Users </h3><p>The client's UI contains a list of users which are currently available for
chatting. This is achieved as follows.
</p><p>If it is the user's first client process he is added to the set of available
users, which is available in an react signal <span class="monospace">Chat.users_signal</span> on a set of
user (i.e. <span class="monospace">User_set.t React.S.t</span>).
As long as a user is available with at least one client he is kept in the value
of the signal. This signal is send to the client when initializing <em>Chat</em>.
Changes in its value are then directly reflected in the list of available users
in the client's UI (c.f.  <span class="monospace">Client.change_users</span>).
</p><p>To observe when a user is not available through a given client process anymore,
<em>Chat</em> awaits for every client process that it is inactive for a given
time.  <span class="monospace">Eliom_comet.Channels.wait_timeout</span> is used for for detecting a client
process to be abandoned.
</p><p>When it is observed that a user isn't avaible through any client process
anymore, he is removed from the <span class="monospace">Chat.users_signal</span>, and all conversation he
is participating are teared down (c.f. <span class="monospace">Chat.remove_client_process</span>).
</p><h3> Starting a conversation </h3><p>When the user selects one of the available users for a conversation, one of two
things may happen (c.f. <span class="monospace">Client.create_or_focus_conversation</span>):
</p><p>Firstly, if there is already a conversation between exactly those two users,
the message prompt is focused.
Secondly, if there is no conversation between those users yet, a new one is created
by calling the server's <span class="monospace">Chat.create_dialog_service</span> (dialog is a conversatio
of two) with the selected user as argument.
</p><p>This service establishes the conversation between the users: It creates the
conversation on the server side (i.e. the set of participants and the bus for
messages) and sends an event to append the conversation to each participant.
Each client is streaming such events (c.f. <span class="monospace">Client.dispatch_event</span>) and
creates the respective UI-element for the conversation with event handlers for
sending and receiving messages in the conversation.
</p><h3> Sending a message in a conversationg </h3><p>Sending messages within an conversation is achieved without any server-side
code; the messages are sent &quot;directly&quot; to all all participants of the
conversation <em>through its Eliom-bus</em>. Two things make this work.
</p><p>Firstly, an event listener on the message prompt of the conversation
(c.f. <span class="monospace">Client.handle_enter_pressed</span>) awaits that the enter-key is hit in
the message prompt of a conversation. It then creates a message and sends it
to the conversation's event bus.
</p><p>Secondly, every participant of a conversation is streaming the messages which
are sent over the conversation bus.
A stream iterator on that bus then displays those messages as they arrive
(c.f. <span class="monospace">Client.dispatch_message</span>).
</p><p>Have fun. <a href="/chat" class="ocsimore_phrasing_link">Be communicative!</a>
</p></div></div></div></body></html>
