<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Saving favorite pictures</title><meta charset="utf8"/><meta content="width=device-width, initial-scale=1" name="viewport"/><link rel="stylesheet" href="/css/style.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/themes/prism.min.css"/><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-core.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-ocaml.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-clike.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-reason.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-javascript.min.js"></script><script src="/js/client.js"></script></head><body class="tuto 3.0 pictures"><div class="project-page"><div class="page-header"><p class="logo-ocsigen"><a href="/" class="ocsimore_phrasing_link"><img src="/img/ocsigen-white.svg" alt="Ocsigen"/></a>
</p><p class="logo-subproject">Doc
</p><ul class="mainmenu"><li class="mainmenu-home"><a href="/" class="ocsimore_phrasing_link">Home</a>
</li><li class="mainmenu-doc mainmenu-current"><a href="/tuto/6.2/manual/intro" class="ocsimore_phrasing_link">Doc</a>
</li><li><a href="/eliom/6.3/manual/intro" class="ocsimore_phrasing_link">Eliom</a>
</li><li><a href="/js_of_ocaml/3.1.0/manual/overview" class="ocsimore_phrasing_link">Js_of_ocaml</a>
</li><li><a href="/lwt/4.1.0/manual/manual" class="ocsimore_phrasing_link">Lwt</a>
</li><li><a href="/tyxml/4.1.0/manual/intro" class="ocsimore_phrasing_link">Tyxml</a>
</li><li><a href="/ocsigen-start/1.1.0/manual/intro" class="ocsimore_phrasing_link">Start</a>
</li></ul><aside class="how-drawer"><input id="how-drawer-toggle" type="checkbox"/><label for="how-drawer-toggle" id="how-drawer-label"><span class="how-drawer-icon"></span></label><nav class="how-drawer-content"><ul class="drawermainmenu"><li class="drawermainmenu-home"><a href="/" class="ocsimore_phrasing_link">Home</a>
</li><li class="drawermainmenu-doc drawermainmenu-current"><a href="/tuto/6.2/manual/intro" class="ocsimore_phrasing_link">Doc</a>
</li><li class="drawermainmenu-project"><a href="/eliom/6.3/manual/intro" class="ocsimore_phrasing_link">Eliom</a>
</li><li class="drawermainmenu-project"><a href="/js_of_ocaml/3.1.0/manual/overview" class="ocsimore_phrasing_link">Js_of_ocaml</a>
</li><li class="drawermainmenu-project"><a href="/ocsigenserver/2.9/manual/quickstart" class="ocsimore_phrasing_link">Server</a>
</li><li class="drawermainmenu-project"><a href="/lwt/4.1.0/manual/manual" class="ocsimore_phrasing_link">Lwt</a>
</li><li class="drawermainmenu-project"><a href="/tyxml/4.1.0/manual/intro" class="ocsimore_phrasing_link">Tyxml</a>
</li><li class="drawermainmenu-project"><a href="/ocsigen-toolkit/1.1.0/manual/intro" class="ocsimore_phrasing_link">Toolkit</a>
</li><li class="drawermainmenu-project"><a href="/ocsigen-start/1.1.0/manual/intro" class="ocsimore_phrasing_link">Start</a>
</li><li class="drawermainmenu-page"><a href="/projects" class="ocsimore_phrasing_link">Other projects</a>
</li><li class="drawermainmenu-page"><a href="/papers" class="ocsimore_phrasing_link">Research papers</a>
</li><li class="drawermainmenu-page"><a href="/credits" class="ocsimore_phrasing_link">Who does Ocsigen?</a>
</li><li class="drawermainmenu-page"><a href="/blog" class="ocsimore_phrasing_link">Blog</a>
</li><li class="drawermainmenu-page"><a href="https://github.com/ocsigen" class="ocsimore_phrasing_link">Source code</a>
</li></ul><nav class="how-doctree"><h1> Tutorial: Your first application</h1><h2><a href="/tuto/3.0/manual/intro" class="ocsimore_phrasing_link">Introduction</a></h2><h2><a href="/tuto/3.0/manual/application" class="ocsimore_phrasing_link">Client/server application</a></h2><h2><a href="/tuto/3.0/manual/interaction" class="ocsimore_phrasing_link">Service based Web programming</a></h2><h2><a href="/tuto/3.0/manual/misc" class="ocsimore_phrasing_link">Miscellaneous features</a></h2><h1> Examples: Learning by example</h1><h2><a href="/tuto/3.0/manual/chat" class="ocsimore_phrasing_link">Chat</a></h2><h1> Mini-tutorials: Some little examples</h1><h2><a href="/tuto/3.0/manual/tutowidgets" class="ocsimore_phrasing_link">Eliom apps basics: writing client server widgets</a></h2><h2><a href="/tuto/3.0/manual/macaque" class="ocsimore_phrasing_link">MaCaQue: SQL queries</a></h2><h2><a href="/tuto/3.0/manual/custom-conf" class="ocsimore_phrasing_link">Custom configuration</a></h2><h2><a href="/tuto/3.0/manual/ocsipersist" class="ocsimore_phrasing_link">Light database</a></h2><h2><a href="/tuto/3.0/manual/pictures" class="ocsimore_phrasing_link">Upload pictures</a></h2><h2><a href="/tuto/3.0/manual/music" class="ocsimore_phrasing_link">Playing music</a></h2><h2><a href="/tuto/3.0/manual/hash-password" class="ocsimore_phrasing_link">Protecting passwords</a></h2></nav></nav></aside></div><p class="reasonwarning">Warning: Reason support is experimental.
We are looking for beta-tester and contributors.
</p><button id="reason">Switch to </button><div class="twocols"><nav class="leftcol">Version <select class="how-versions" onchange="location = this.value;"><option value="/tuto/dev/manual/pictures">dev</option><option value="/tuto/6.2/manual/pictures">6.2</option><option value="/tuto/6.1/manual/pictures">6.1</option><option value="/tuto/6.0/manual/pictures">6.0</option><option value="/tuto/5.0/manual/pictures">5.0</option><option value="/tuto/4.2/manual/pictures">4.2</option><option value="/tuto/4.1/manual/pictures">4.1</option><option value="/tuto/4.0/manual/pictures">4.0</option><option selected="selected">3.0</option><option value="/tuto/2.2/manual/pictures">2.2</option><option value="/tuto/2.0/manual/pictures">2.0</option></select><form id="search"><input name="q" id="q" placeholder="search ..."/><button>Search</button></form><nav class="how-doctree"><h1> Tutorial: Your first application</h1><h2><a href="/tuto/3.0/manual/intro" class="ocsimore_phrasing_link">Introduction</a></h2><h2><a href="/tuto/3.0/manual/application" class="ocsimore_phrasing_link">Client/server application</a></h2><h2><a href="/tuto/3.0/manual/interaction" class="ocsimore_phrasing_link">Service based Web programming</a></h2><h2><a href="/tuto/3.0/manual/misc" class="ocsimore_phrasing_link">Miscellaneous features</a></h2><h1> Examples: Learning by example</h1><h2><a href="/tuto/3.0/manual/chat" class="ocsimore_phrasing_link">Chat</a></h2><h1> Mini-tutorials: Some little examples</h1><h2><a href="/tuto/3.0/manual/tutowidgets" class="ocsimore_phrasing_link">Eliom apps basics: writing client server widgets</a></h2><h2><a href="/tuto/3.0/manual/macaque" class="ocsimore_phrasing_link">MaCaQue: SQL queries</a></h2><h2><a href="/tuto/3.0/manual/custom-conf" class="ocsimore_phrasing_link">Custom configuration</a></h2><h2><a href="/tuto/3.0/manual/ocsipersist" class="ocsimore_phrasing_link">Light database</a></h2><h2><a href="/tuto/3.0/manual/pictures" class="ocsimore_phrasing_link">Upload pictures</a></h2><h2><a href="/tuto/3.0/manual/music" class="ocsimore_phrasing_link">Playing music</a></h2><h2><a href="/tuto/3.0/manual/hash-password" class="ocsimore_phrasing_link">Protecting passwords</a></h2></nav></nav><article class="rightcol"><h1>Saving favorite pictures</h1><aside class="concepts"><header><h5>Concepts</h5></header><p>Atom feed</p></aside><p>We will now add a button to the application to save the current
image. The images will be saved to the filesystem using the module
<span><a class="ocsforge_doclink_lwt" href="/lwt/4.1.0/api/Lwt_io">Lwt_io</a></span>. We will then make an Atom feed
with the saved images using <span><a class="ocsforge_doclink_eliom" href="/eliom/dev/api/server/Atom_feed">Atom_feed</a></span>.
</p><p>We save the images in the directory containing the static contents
under the directory <span class="teletype">images_saved/username</span>. The <span class="teletype">username</span>
directory is created if needed. If it already exists <span class="teletype">mkdir</span> fails
and we do nothing.
</p><p>We will add this code in a new file:
</p><h4><span class="teletype">feed.ml</span></h4><pre class=""><code class="language-ocaml translatable">open Eliom_content.Html5.D

let static_dir = &quot;/tmp/static/&quot;

let image_dir name =
  let dir = static_dir ^ &quot;/graffiti_saved/&quot; ^ (Url.encode name) in
  (try_lwt Lwt_unix.mkdir dir 511 with
    | _ -&gt; debug &quot;could not create the directory %s&quot; dir; Lwt.return ())
  &gt;|= (fun () -&gt; dir)

let make_filename name number =
  image_dir name &gt;|= fun dir -&gt;
  dir ^ &quot;/&quot; ^ (string_of_int number) ^ &quot;.png&quot;

let save image name number =
  lwt file_name = make_filename name number in
  lwt out_chan = Lwt_io.open_file ~mode:Lwt_io.output file_name in
  Lwt_io.write out_chan image</code></pre><p>We number images and associate to each image the time of creation. It
is stocked in an <span><a class="ocsforge_doclink_eliom" href="/eliom/6.3/api/server/Ocsipersist">Ocsipersist</a></span>
table.
</p><pre class=""><code class="language-ocaml translatable">let image_info_table = Ocsipersist.open_table &quot;image_info_table&quot;</code></pre><p>For each user, we stock a value of type<br/>
<span class="teletype"> int * CalendarLib.Calendar.t * ((int * CalendarLib.Calendar.t) list)</span>.
The first integer is the name under which will be saved the image, the first
time is the last update for that user and the list contains the names and
times of old images. We need those times to timestamp the entries of the feed.
</p><pre class=""><code class="language-ocaml translatable">let save_image username =
  let now = CalendarLib.Calendar.now () in
  lwt number,_,list =
    try_lwt Ocsipersist.find image_info_table username with
      | Not_found -&gt; Lwt.return (0,now,[])
      | e -&gt; Lwt.fail e
  in
  lwt () = Ocsipersist.add image_info_table
    username (number+1,now,(number,now)::list) in
  let (_,image_string) = Hashtbl.find graffiti_info username in
  save (image_string ()) username number

let save_image_box name =
  let save_image_service =
    Eliom_registration.Action.register_post_coservice'
      ~post_params:Eliom_parameter.unit
      (fun () () -&gt; save_image name)
  in
  post_form save_image_service
    (fun _ -&gt;
      [p [string_input ~input_type:`Submit ~value:&quot;save&quot; ()]]) ()</code></pre><p>We find the url of the images with <span><a class="ocsforge_doclink_eliom" href="/eliom/6.3/api/server/Eliom_service#VALstatic_dir">Eliom_service.​static_dir</a></span>.
It is a service taking file path as
parameter, serving the content of the static directory. We use <span><a class="ocsforge_doclink_eliom" href="/eliom/6.3/api/server/Eliom_uri#VALmake_string_uri">Eliom_uri.​make_string_uri</a></span> to get the
url as a string.
</p><pre class=""><code class="language-ocaml translatable">let feed_service = Eliom_service.service ~path:[&quot;feed&quot;]
  ~get_params:(Eliom_parameter.string &quot;name&quot;) ()

let local_filename name number =
  [&quot;graffiti_saved&quot;; Url.encode name ; (string_of_int number) ^ &quot;.png&quot;]

let rec entries name list = function
  | 0 -&gt; []
  | len -&gt;
    match list with
      | [] -&gt; []
      | (n,saved)::q -&gt;
	let title = Atom_feed.plain
	  (&quot;graffiti &quot; ^ name ^ &quot; &quot; ^ (string_of_int n)) in
	let uri =
	  make_string_uri ~absolute:true
	    ~service:(Eliom_service.static_dir ())
	    (local_filename name n)
	in
	let entry =
	  Atom_feed.entry ~title ~id:uri ~updated:saved
            [Atom_feed.html5C [ img ~src:uri ~alt:&quot;image&quot; ()]] in
	entry::(entries name q (len - 1))

let feed name () =
  let id = make_string_uri
    ~absolute:true
    ~service:feed_service name in
  let title = Atom_feed.plain (&quot;nice drawings of &quot; ^ name) in
  Lwt.catch
    (fun () -&gt; Ocsipersist.find image_info_table name &gt;|=
	(fun (number,updated,list) -&gt;
	  Atom_feed.feed ~id ~updated ~title (entries name list 10)))
    ( function Not_found -&gt;
      let now = CalendarLib.Calendar.now () in
      Lwt.return (Atom_feed.feed ~id ~updated:now ~title [])
      | e -&gt; Lwt.fail e )

let () = Eliom_atom.Reg.register ~service:feed_service feed</code></pre><p>And then use the new module as follow:
</p><pre class=""><code class="language-ocaml translatable">[ a Feed.feed_service [pcdata &quot;atom feed&quot;] name;
    div (if name = username
      then [Feed.save_image_box name]
      else [pcdata &quot;no saving&quot;]);
  ]</code></pre></article></div></div></body></html>
