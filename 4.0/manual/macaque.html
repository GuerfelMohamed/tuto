<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Type safe database requests using Macaque</title><meta charset="utf8"/><meta content="width=device-width, initial-scale=1" name="viewport"/><link rel="stylesheet" href="/css/style.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/themes/prism.min.css"/><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-core.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-ocaml.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-clike.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-reason.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-javascript.min.js"></script><script src="/js/client.js"></script></head><body class="tuto 4.0 macaque"><div class="project-page"><div class="page-header"><p class="logo-ocsigen"><a href="/" class="ocsimore_phrasing_link"><img src="/img/ocsigen-white.svg" alt="Ocsigen"/></a>
</p><p class="logo-subproject">Doc
</p><ul class="mainmenu"><li class="mainmenu-home"><a href="/" class="ocsimore_phrasing_link">Home</a>
</li><li class="mainmenu-doc mainmenu-current"><a href="/tuto/6.2/manual/intro" class="ocsimore_phrasing_link">Doc</a>
</li><li><a href="/eliom/6.3/manual/intro" class="ocsimore_phrasing_link">Eliom</a>
</li><li><a href="/js_of_ocaml/3.1.0/manual/overview" class="ocsimore_phrasing_link">Js_of_ocaml</a>
</li><li><a href="/lwt/3.2.1/manual/manual" class="ocsimore_phrasing_link">Lwt</a>
</li><li><a href="/tyxml/4.1.0/manual/intro" class="ocsimore_phrasing_link">Tyxml</a>
</li><li><a href="/ocsigen-start/1.1.0/manual/intro" class="ocsimore_phrasing_link">Start</a>
</li></ul><div class="how-drawer"><input id="how-drawer-toggle" type="checkbox"/><label for="how-drawer-toggle" id="how-drawer-label"><span class="how-drawer-icon"></span></label><nav class="how-drawer-content"><ul class="drawermainmenu"><li class="drawermainmenu-home"><a href="/" class="ocsimore_phrasing_link">Home</a>
</li><li class="drawermainmenu-doc drawermainmenu-current"><a href="/tuto/6.2/manual/intro" class="ocsimore_phrasing_link">Doc</a>
</li><li class="drawermainmenu-project"><a href="/eliom/6.3/manual/intro" class="ocsimore_phrasing_link">Eliom</a>
</li><li class="drawermainmenu-project"><a href="/js_of_ocaml/3.1.0/manual/overview" class="ocsimore_phrasing_link">Js_of_ocaml</a>
</li><li class="drawermainmenu-project"><a href="/ocsigenserver/2.9/manual/quickstart" class="ocsimore_phrasing_link">Server</a>
</li><li class="drawermainmenu-project"><a href="/lwt/3.2.1/manual/manual" class="ocsimore_phrasing_link">Lwt</a>
</li><li class="drawermainmenu-project"><a href="/tyxml/4.1.0/manual/intro" class="ocsimore_phrasing_link">Tyxml</a>
</li><li class="drawermainmenu-project"><a href="/ocsigen-toolkit/1.1.0/manual/intro" class="ocsimore_phrasing_link">Toolkit</a>
</li><li class="drawermainmenu-project"><a href="/ocsigen-start/1.1.0/manual/intro" class="ocsimore_phrasing_link">Start</a>
</li><li class="drawermainmenu-page"><a href="/projects" class="ocsimore_phrasing_link">Other projects</a>
</li><li class="drawermainmenu-page"><a href="/papers" class="ocsimore_phrasing_link">Research papers</a>
</li><li class="drawermainmenu-page"><a href="/credits" class="ocsimore_phrasing_link">Who does Ocsigen?</a>
</li><li class="drawermainmenu-page"><a href="/blog" class="ocsimore_phrasing_link">Blog</a>
</li><li class="drawermainmenu-page"><a href="https://github.com/ocsigen" class="ocsimore_phrasing_link">Source code</a>
</li></ul><div class="how-doctree"><h1> Tutorial: Your first application</h1><h2><a href="/tuto/4.0/manual/intro" class="ocsimore_phrasing_link">Introduction. Ocsigen: the different projects</a></h2><h2><a href="/tuto/4.0/manual/application" class="ocsimore_phrasing_link">Client/server application</a></h2><h2><a href="/tuto/4.0/manual/interaction" class="ocsimore_phrasing_link">Service based Web programming</a></h2><h2><a href="/tuto/4.0/manual/misc" class="ocsimore_phrasing_link">Miscellaneous features</a></h2><h1> Examples: Learning by example</h1><h2><a href="/tuto/4.0/manual/chat" class="ocsimore_phrasing_link">Chat</a></h2><h1> Mini-tutorials: Some little examples</h1><h2><a href="/tuto/4.0/manual/basicwebsite" class="ocsimore_phrasing_link">A basic Web site in OCaml</a></h2><h2><a href="/tuto/4.0/manual/tutowidgets" class="ocsimore_phrasing_link">Eliom apps basics: writing client server widgets</a></h2><h2><a href="/tuto/4.0/manual/macaque" class="ocsimore_phrasing_link">MaCaQue: SQL queries</a></h2><h2><a href="/tuto/4.0/manual/custom-conf" class="ocsimore_phrasing_link">Custom configuration</a></h2><h2><a href="/tuto/4.0/manual/ocsipersist" class="ocsimore_phrasing_link">Light database</a></h2><h2><a href="/tuto/4.0/manual/pictures" class="ocsimore_phrasing_link">Download pictures</a></h2><h2><a href="/tuto/4.0/manual/music" class="ocsimore_phrasing_link">Playing music</a></h2><h2><a href="/tuto/4.0/manual/reactivemediaplayer" class="ocsimore_phrasing_link">Reactive media player</a></h2><h2><a href="/tuto/4.0/manual/hash-password" class="ocsimore_phrasing_link">Protecting passwords</a></h2><h2><a href="/tuto/4.0/manual/rest" class="ocsimore_phrasing_link">RESTful JSON API</a></h2><h1 class="howto"> HOW-TO</h1><h2> My first steps with Ocsigen</h2><h3><a href="/tuto/4.0/manual/how-to-install-ocsigen" class="ocsimore_phrasing_link">How to install Ocsigen</a></h3><h3><a href="/tuto/4.0/manual/how-to-make-hello-world-in-ocsigen" class="ocsimore_phrasing_link">How to make &quot;hello world&quot; in Ocsigen</a></h3><h3><a href="/tuto/4.0/manual/how-to-compile-my-ocsigen-pages" class="ocsimore_phrasing_link">How to compile my Ocsigen pages</a></h3><h3><a href="/tuto/4.0/manual/how-to-configure-and-launch-the-ocsigen-server" class="ocsimore_phrasing_link">How to configure and launch the Ocsigen Server</a></h3><h3><a href="/tuto/4.0/manual/how-does-a-page-s-source-code-look" class="ocsimore_phrasing_link">How does a client-server app source code look like?</a></h3><h2> How to put some elements in my page ?</h2><h3><a href="/tuto/4.0/manual/how-to-make-page-a-skeleton" class="ocsimore_phrasing_link">How to make a page skeleton</a></h3><h3><a href="/tuto/4.0/manual/how-to-use-get-parameters-or-parameters-in-the-url" class="ocsimore_phrasing_link">How to use GET parameters (parameters in the URL)</a></h3><h3><a href="/tuto/4.0/manual/how-to-add-css-stylesheet" class="ocsimore_phrasing_link">How to add CSS stylesheet</a></h3><h3><a href="/tuto/4.0/manual/how-to-add-a-javascript-script" class="ocsimore_phrasing_link">How to add a Javascript script</a></h3><h3><a href="/tuto/4.0/manual/how-to-add-a-favicon" class="ocsimore_phrasing_link">How to add a Favicon</a></h3><h3><a href="/tuto/4.0/manual/how-to-add-a-div" class="ocsimore_phrasing_link">How to add a div</a></h3><h3><a href="/tuto/4.0/manual/how-to-add-a-list" class="ocsimore_phrasing_link">How to add lists in pages?</a></h3><h3><a href="/tuto/4.0/manual/how-to-add-an-image" class="ocsimore_phrasing_link">How to add an image</a></h3><h3><a href="/tuto/4.0/manual/how-to-write-titles-and-paragraphs" class="ocsimore_phrasing_link">How to write titles and paragraphs</a></h3><h3><a href="/tuto/4.0/manual/how-to-set-and-id-classes-or-other-attributes-to-html-elements" class="ocsimore_phrasing_link">How to set and id, classes or other attributes to HTML elements</a></h3><h3><a href="/tuto/4.0/manual/how-to-add-a-select-or-other-form-element" class="ocsimore_phrasing_link">How to add select (or other form element)</a></h3><h3><a href="/tuto/4.0/manual/how-to-insert-raw-form-elements-not-belonging-to-a-form-towards-a-service" class="ocsimore_phrasing_link">How to insert &quot;raw&quot; form elements (not belonging to a form towards a service)</a></h3><h3><a href="/tuto/4.0/manual/how-to-make-responsive-css" class="ocsimore_phrasing_link">How to make responsive CSS</a></h3><h2> Services</h2><h3><a href="/tuto/4.0/manual/how-to-do-links-to-other-pages" class="ocsimore_phrasing_link">How to do links to other pages</a></h3><h3><a href="/tuto/4.0/manual/how-to-write-forms" class="ocsimore_phrasing_link">How to write forms</a></h3><h3><a href="/tuto/4.0/manual/how-to-register-a-service-that-decides-itself-what-to-send" class="ocsimore_phrasing_link">How to register a service that decides itself what to send</a></h3><h3><a href="/tuto/4.0/manual/how-to-create-link-to-a-current-page-without-knowing-its-url" class="ocsimore_phrasing_link">How to create link to a current page (without knowing its URL)</a></h3><h3><a href="/tuto/4.0/manual/how-to-create-form-wizard-sequence-of-pages-depending-on-data-entered-on-previous-ones" class="ocsimore_phrasing_link">How to create form wizard (sequence of pages depending on data entered on previous ones)</a></h3><h3><a href="/tuto/4.0/manual/how-to-write-a-json-service" class="ocsimore_phrasing_link">How to write a JSON service</a></h3><h3><a href="/tuto/4.0/manual/how-to-send-file-download" class="ocsimore_phrasing_link">How to send a file (download)</a></h3><h3><a href="/tuto/4.0/manual/how-to-send-file-upload" class="ocsimore_phrasing_link">How to send a file (upload)</a></h3><h2> Sessions</h2><h3><a href="/tuto/4.0/manual/how-to-register-session-data" class="ocsimore_phrasing_link">How to register session data</a></h3><h2> Js_of_ocaml</h2><h3><a href="/tuto/4.0/manual/how-to-attach-ocaml-values-to-dom-elements" class="ocsimore_phrasing_link">How to attach OCaml values to DOM elements</a></h3><h3><a href="/tuto/4.0/manual/how-to-know-whether-the-browser-window-has-the-focus-or-not" class="ocsimore_phrasing_link">How to know whether the browser window has the focus or not</a></h3><h3><a href="/tuto/4.0/manual/how-to-build-js-object" class="ocsimore_phrasing_link">How to build js object</a></h3><h3><a href="/tuto/4.0/manual/how-to-stop-default-behaviour-of-events" class="ocsimore_phrasing_link">How to stop default behaviour of events</a></h3><h3><a href="/tuto/4.0/manual/how-to-call-an-ocaml-function-from-js-code" class="ocsimore_phrasing_link">Howt to call an OCaml function from js code</a></h3><h2> Eliom client-server applications</h2><h3><a href="/tuto/4.0/manual/how-to-call-a-server-side-function-from-client-side" class="ocsimore_phrasing_link">How to call a server side function from a client side</a></h3><h3><a href="/tuto/4.0/manual/how-to-make-the-client-side-program-get-an-html-element-from-the-server-and-insert-it-in-the-page" class="ocsimore_phrasing_link">How to make the client side program get an HTML element from the server and insert it in the page</a></h3><h3><a href="/tuto/4.0/manual/how-to-attach-ocaml-values-to-the-html-nodes-sent-to-the-client" class="ocsimore_phrasing_link">How to attach OCaml values to the HTML nodes sent to the client</a></h3><h3><a href="/tuto/4.0/manual/how-to-iterate-on-all-sessions-for-one-user-or-all-tabs" class="ocsimore_phrasing_link">How to iterate on all sessions for one user, or all tabs</a></h3><h3><a href="/tuto/4.0/manual/how-to-implement-a-notification-system" class="ocsimore_phrasing_link">How to implement a notification system</a></h3><h3><a href="/tuto/4.0/manual/how-to-send-a-file-to-server-without-stopping-the-client-process" class="ocsimore_phrasing_link">How to send a file to server without stopping the client process</a></h3><h3><a href="/tuto/4.0/manual/how-to-detect-on-client-side-that-the-server-side-state-for-the-process-is-closed" class="ocsimore_phrasing_link">How to detect on client side that the server side state for the process is closed</a></h3><h2> Database</h2><h3><a href="/tuto/4.0/manual/how-to-use-a-database-with-eliom" class="ocsimore_phrasing_link">How to use a database with Eliom</a></h3><h2> Eliom Server side</h2><h3><a href="/tuto/4.0/manual/how-do-i-create-a-cryptographically-safe-identifier" class="ocsimore_phrasing_link">How do I create a Cryptographically safe identifier</a></h3><h3><a href="/tuto/4.0/manual/how-can-i-extend-the-configuration-file-parsing-with-application-specific-entry" class="ocsimore_phrasing_link">How can I extend the configuration file parsing with applicaiton-specific entry</a></h3></div></nav></div></div><button id="reason">Switch to </button><div class="twocols"><div class="leftcol"><div class="how-versions"><input id="how-versions-toggle" type="checkbox"/><label for="how-versions-toggle" class="how-versions-current">Version 4.0</label><div class="how-versions-all"><a href="/tuto/dev/manual/macaque">dev</a><a href="/tuto/6.2/manual/macaque">6.2</a><a href="/tuto/6.1/manual/macaque">6.1</a><a href="/tuto/6.0/manual/macaque">6.0</a><a href="/tuto/5.0/manual/macaque">5.0</a><a href="/tuto/4.2/manual/macaque">4.2</a><a href="/tuto/4.1/manual/macaque">4.1</a><span class="how-versions-all-current">4.0</span><a href="/tuto/3.0/manual/macaque">3.0</a><a href="/tuto/2.2/manual/macaque">2.2</a><a href="/tuto/2.0/manual/macaque">2.0</a></div></div><form id="search"><input name="q" id="q" placeholder="search ..."/><button>Search</button></form><div class="how-doctree"><h1> Tutorial: Your first application</h1><h2><a href="/tuto/4.0/manual/intro" class="ocsimore_phrasing_link">Introduction. Ocsigen: the different projects</a></h2><h2><a href="/tuto/4.0/manual/application" class="ocsimore_phrasing_link">Client/server application</a></h2><h2><a href="/tuto/4.0/manual/interaction" class="ocsimore_phrasing_link">Service based Web programming</a></h2><h2><a href="/tuto/4.0/manual/misc" class="ocsimore_phrasing_link">Miscellaneous features</a></h2><h1> Examples: Learning by example</h1><h2><a href="/tuto/4.0/manual/chat" class="ocsimore_phrasing_link">Chat</a></h2><h1> Mini-tutorials: Some little examples</h1><h2><a href="/tuto/4.0/manual/basicwebsite" class="ocsimore_phrasing_link">A basic Web site in OCaml</a></h2><h2><a href="/tuto/4.0/manual/tutowidgets" class="ocsimore_phrasing_link">Eliom apps basics: writing client server widgets</a></h2><h2><a href="/tuto/4.0/manual/macaque" class="ocsimore_phrasing_link">MaCaQue: SQL queries</a></h2><h2><a href="/tuto/4.0/manual/custom-conf" class="ocsimore_phrasing_link">Custom configuration</a></h2><h2><a href="/tuto/4.0/manual/ocsipersist" class="ocsimore_phrasing_link">Light database</a></h2><h2><a href="/tuto/4.0/manual/pictures" class="ocsimore_phrasing_link">Download pictures</a></h2><h2><a href="/tuto/4.0/manual/music" class="ocsimore_phrasing_link">Playing music</a></h2><h2><a href="/tuto/4.0/manual/reactivemediaplayer" class="ocsimore_phrasing_link">Reactive media player</a></h2><h2><a href="/tuto/4.0/manual/hash-password" class="ocsimore_phrasing_link">Protecting passwords</a></h2><h2><a href="/tuto/4.0/manual/rest" class="ocsimore_phrasing_link">RESTful JSON API</a></h2><h1 class="howto"> HOW-TO</h1><h2> My first steps with Ocsigen</h2><h3><a href="/tuto/4.0/manual/how-to-install-ocsigen" class="ocsimore_phrasing_link">How to install Ocsigen</a></h3><h3><a href="/tuto/4.0/manual/how-to-make-hello-world-in-ocsigen" class="ocsimore_phrasing_link">How to make &quot;hello world&quot; in Ocsigen</a></h3><h3><a href="/tuto/4.0/manual/how-to-compile-my-ocsigen-pages" class="ocsimore_phrasing_link">How to compile my Ocsigen pages</a></h3><h3><a href="/tuto/4.0/manual/how-to-configure-and-launch-the-ocsigen-server" class="ocsimore_phrasing_link">How to configure and launch the Ocsigen Server</a></h3><h3><a href="/tuto/4.0/manual/how-does-a-page-s-source-code-look" class="ocsimore_phrasing_link">How does a client-server app source code look like?</a></h3><h2> How to put some elements in my page ?</h2><h3><a href="/tuto/4.0/manual/how-to-make-page-a-skeleton" class="ocsimore_phrasing_link">How to make a page skeleton</a></h3><h3><a href="/tuto/4.0/manual/how-to-use-get-parameters-or-parameters-in-the-url" class="ocsimore_phrasing_link">How to use GET parameters (parameters in the URL)</a></h3><h3><a href="/tuto/4.0/manual/how-to-add-css-stylesheet" class="ocsimore_phrasing_link">How to add CSS stylesheet</a></h3><h3><a href="/tuto/4.0/manual/how-to-add-a-javascript-script" class="ocsimore_phrasing_link">How to add a Javascript script</a></h3><h3><a href="/tuto/4.0/manual/how-to-add-a-favicon" class="ocsimore_phrasing_link">How to add a Favicon</a></h3><h3><a href="/tuto/4.0/manual/how-to-add-a-div" class="ocsimore_phrasing_link">How to add a div</a></h3><h3><a href="/tuto/4.0/manual/how-to-add-a-list" class="ocsimore_phrasing_link">How to add lists in pages?</a></h3><h3><a href="/tuto/4.0/manual/how-to-add-an-image" class="ocsimore_phrasing_link">How to add an image</a></h3><h3><a href="/tuto/4.0/manual/how-to-write-titles-and-paragraphs" class="ocsimore_phrasing_link">How to write titles and paragraphs</a></h3><h3><a href="/tuto/4.0/manual/how-to-set-and-id-classes-or-other-attributes-to-html-elements" class="ocsimore_phrasing_link">How to set and id, classes or other attributes to HTML elements</a></h3><h3><a href="/tuto/4.0/manual/how-to-add-a-select-or-other-form-element" class="ocsimore_phrasing_link">How to add select (or other form element)</a></h3><h3><a href="/tuto/4.0/manual/how-to-insert-raw-form-elements-not-belonging-to-a-form-towards-a-service" class="ocsimore_phrasing_link">How to insert &quot;raw&quot; form elements (not belonging to a form towards a service)</a></h3><h3><a href="/tuto/4.0/manual/how-to-make-responsive-css" class="ocsimore_phrasing_link">How to make responsive CSS</a></h3><h2> Services</h2><h3><a href="/tuto/4.0/manual/how-to-do-links-to-other-pages" class="ocsimore_phrasing_link">How to do links to other pages</a></h3><h3><a href="/tuto/4.0/manual/how-to-write-forms" class="ocsimore_phrasing_link">How to write forms</a></h3><h3><a href="/tuto/4.0/manual/how-to-register-a-service-that-decides-itself-what-to-send" class="ocsimore_phrasing_link">How to register a service that decides itself what to send</a></h3><h3><a href="/tuto/4.0/manual/how-to-create-link-to-a-current-page-without-knowing-its-url" class="ocsimore_phrasing_link">How to create link to a current page (without knowing its URL)</a></h3><h3><a href="/tuto/4.0/manual/how-to-create-form-wizard-sequence-of-pages-depending-on-data-entered-on-previous-ones" class="ocsimore_phrasing_link">How to create form wizard (sequence of pages depending on data entered on previous ones)</a></h3><h3><a href="/tuto/4.0/manual/how-to-write-a-json-service" class="ocsimore_phrasing_link">How to write a JSON service</a></h3><h3><a href="/tuto/4.0/manual/how-to-send-file-download" class="ocsimore_phrasing_link">How to send a file (download)</a></h3><h3><a href="/tuto/4.0/manual/how-to-send-file-upload" class="ocsimore_phrasing_link">How to send a file (upload)</a></h3><h2> Sessions</h2><h3><a href="/tuto/4.0/manual/how-to-register-session-data" class="ocsimore_phrasing_link">How to register session data</a></h3><h2> Js_of_ocaml</h2><h3><a href="/tuto/4.0/manual/how-to-attach-ocaml-values-to-dom-elements" class="ocsimore_phrasing_link">How to attach OCaml values to DOM elements</a></h3><h3><a href="/tuto/4.0/manual/how-to-know-whether-the-browser-window-has-the-focus-or-not" class="ocsimore_phrasing_link">How to know whether the browser window has the focus or not</a></h3><h3><a href="/tuto/4.0/manual/how-to-build-js-object" class="ocsimore_phrasing_link">How to build js object</a></h3><h3><a href="/tuto/4.0/manual/how-to-stop-default-behaviour-of-events" class="ocsimore_phrasing_link">How to stop default behaviour of events</a></h3><h3><a href="/tuto/4.0/manual/how-to-call-an-ocaml-function-from-js-code" class="ocsimore_phrasing_link">Howt to call an OCaml function from js code</a></h3><h2> Eliom client-server applications</h2><h3><a href="/tuto/4.0/manual/how-to-call-a-server-side-function-from-client-side" class="ocsimore_phrasing_link">How to call a server side function from a client side</a></h3><h3><a href="/tuto/4.0/manual/how-to-make-the-client-side-program-get-an-html-element-from-the-server-and-insert-it-in-the-page" class="ocsimore_phrasing_link">How to make the client side program get an HTML element from the server and insert it in the page</a></h3><h3><a href="/tuto/4.0/manual/how-to-attach-ocaml-values-to-the-html-nodes-sent-to-the-client" class="ocsimore_phrasing_link">How to attach OCaml values to the HTML nodes sent to the client</a></h3><h3><a href="/tuto/4.0/manual/how-to-iterate-on-all-sessions-for-one-user-or-all-tabs" class="ocsimore_phrasing_link">How to iterate on all sessions for one user, or all tabs</a></h3><h3><a href="/tuto/4.0/manual/how-to-implement-a-notification-system" class="ocsimore_phrasing_link">How to implement a notification system</a></h3><h3><a href="/tuto/4.0/manual/how-to-send-a-file-to-server-without-stopping-the-client-process" class="ocsimore_phrasing_link">How to send a file to server without stopping the client process</a></h3><h3><a href="/tuto/4.0/manual/how-to-detect-on-client-side-that-the-server-side-state-for-the-process-is-closed" class="ocsimore_phrasing_link">How to detect on client side that the server side state for the process is closed</a></h3><h2> Database</h2><h3><a href="/tuto/4.0/manual/how-to-use-a-database-with-eliom" class="ocsimore_phrasing_link">How to use a database with Eliom</a></h3><h2> Eliom Server side</h2><h3><a href="/tuto/4.0/manual/how-do-i-create-a-cryptographically-safe-identifier" class="ocsimore_phrasing_link">How do I create a Cryptographically safe identifier</a></h3><h3><a href="/tuto/4.0/manual/how-can-i-extend-the-configuration-file-parsing-with-application-specific-entry" class="ocsimore_phrasing_link">How can I extend the configuration file parsing with applicaiton-specific entry</a></h3></div></div><div class="rightcol"><h1>Type safe database requests using Macaque</h1><aside class="concepts"><header><h5>Concepts</h5></header><p>Type safe database requests</p></aside><p>We will implement our database access function using
the Macaque library, that allows easy manipulation of Postgresql
database fully compatible with Lwt. (For more information see
<a href="wiki(25):" class="ocsimore_phrasing_link"> Macaque manual</a>).
</p><p>We will store the login and the password of users in a Postgresql
database. For more information on how to set up and run it, see
<a href="http://www.postgresql.org/docs/9.0/static/index.html" class="ocsimore_phrasing_link">Postgresql
manual</a>.
</p><p>When the base is up and running, we create the base by running in a shell:
</p><pre class="manually-translated"><code class="language-sh">$ createdb testbase</code></pre><p>Then we create the <span class="teletype">users</span> table, by executing this sql script:
</p><pre class="manually-translated"><code class="language-sql">CREATE TABLE users (
       login text NOT NULL,
       password text NOT NULL
);</code></pre><p>We save it under <span class="teletype">create_table.sql</span> and run
</p><pre class="manually-translated"><code class="language-sh">$ psql -d testbase -f create_table.sql</code></pre><p>Macaque can use any thread library that provides a monadic
interface. The default one provides simple blocking access to the
database. It isn't good for us because an access to the base by one
user will prevent the server from handling anything else until the
request is finished. We need a version of Macaque specialised for
Lwt. It is obtained by
</p><pre class=""><code class="language-ocaml translatable">module Lwt_thread = struct
  include Lwt
  include Lwt_chan
end
module Lwt_PGOCaml = PGOCaml_generic.Make(Lwt_thread)
module Lwt_Query = Query.Make_with_Db(Lwt_thread)(Lwt_PGOCaml)</code></pre><p>We can now open the database with our newly created <span class="teletype">Lwt_PGOCaml.connect</span>.
</p><pre class=""><code class="language-ocaml translatable">let get_db : unit -&gt; unit Lwt_PGOCaml.t Lwt.t =
  let db_handler = ref None in
  fun () -&gt;
    match !db_handler with
      | Some h -&gt; Lwt.return h
      | None -&gt; Lwt_PGOCaml.connect ~database:&quot;testbase&quot; ()</code></pre><p>Then we declare the table on which we will work and the different
requests we do on it.
</p><pre class=""><code class="language-ocaml translatable">let table = &lt;:table&lt; users (
  login text NOT NULL,
  password text NOT NULL
) ~&gt;&gt;

let find name =
  (get_db () ~&gt;&gt;= fun dbh -&gt;
   Lwt_Query.view dbh
   &lt;:view&lt; {password = user_.password} |
            user_ in $table$;
            user_.login = $string:name$; ~&gt;&gt;)

let insert name pwd =
  get_db () ~&gt;&gt;= fun dbh -&gt;
  Lwt_Query.query dbh
  &lt;:insert&lt; $table$ :=
    { login = $string:name$; password = $string:pwd$; } ~&gt;&gt;</code></pre><p>Finally, we modify the handling code :
</p><pre class=""><code class="language-ocaml translatable">let check_pwd name pwd =
  (get_db () ~&gt;&gt;= fun dbh -&gt;
   Lwt_Query.view dbh
   &lt;:view&lt; {password = user_.password} |
            user_ in $table$;
            user_.login = $string:name$;
	    user_.password = $string:pwd$ ~&gt;&gt;)
  &gt;|= (function [] -&gt; false | _ -&gt; true)

let () = Eliom_registration.Action.register
  ~service:create_account_service
  (fun () (name, pwd) -&gt;
    find name ~&gt;&gt;=
      (function
	| [] -&gt; insert name pwd
	| _ -&gt; Lwt.return ()) )

let () = Eliom_registration.Action.register
  ~service:connection_service
  (fun () (name, password) -&gt;
    check_pwd name password ~&gt;&gt;=
      (function
	| true -&gt; Eliom_reference.set username (Some name)
	| false -&gt; Lwt.return ()))</code></pre><p>We need to reference <span class="teletype">macaque</span> in the <span class="teletype">Makefile</span> :
</p><pre>SERVER_PACKAGE := macaque.syntax
</pre><p>and in <span class="teletype">ocsigenserver.conf</span> :
</p><pre>&lt;extension findlib-package=&quot;macaque&quot;/&gt;
</pre></div></div></div></body></html>
